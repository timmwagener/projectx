# .gitlab-ci.yml
# Register own runners if needed.
# Currently linux only.

image: python:3.7-stretch

before_script:
  - python --version
  - pip --version
  - pip install tox

stages:
  - test
  - lint
  - document
  - publish
  - build

unittests_core:
  stage: test
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  script:
    - tox -e unittests_core

unittests_ui:
  stage: test
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  allow_failure: true  # because of problem with linux and pyside2
  script:
    - tox -e unittests_ui

systemtests_core:
  stage: test
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  script:
    - tox -e systemtests_core

systemtests_ui:
  stage: test
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  allow_failure: true  # because of problem with linux and pyside2
  script:
    - tox -e systemtests_ui

flake8:
  stage: lint
  allow_failure: true
  script:
    - tox -e flake8

pylint:
  stage: lint
  allow_failure: true
  script:
    - tox -e pylint

docs:
  stage: document
  script:
    - tox -e apidocs
    - tox -e docs
  artifacts:
    paths:
      - docs/build/html/
    expire_in: 1 week

pages:
  stage: publish
  before_script:  # overwrite global settings for efficiency
    - echo "noop"
  dependencies:  # download artifacts of these jobs
    - docs
  script:
    - mv docs/build/html/ public/
  artifacts:
    paths:
      - public
  only:
    - develop

# exe doesn't apply for linux
exe:
  stage: build
  allow_failure: true  # because of problem with linux and pyside2
  script:
    - tox -e exe
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
